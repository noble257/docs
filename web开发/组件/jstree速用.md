# JsTree 组件速用

* 官网 https://www.jstree.com/
* 好记性不如烂笔头,官方的文档组织性真的差



### 快速前后端交互

* 前端

  ```js
  $('#tree').jstree({
      core: {
          data: { url: function(node){ return '/cat/jstree?id=' + node.id; } }
      }
  });
  ```


* 后端(laravel php示例)

  返回数据包含 id, text 即可. children=true 表示有子级

  ```php
  class CatController extends Controller
  {
      public function jstree(Request $request) {
          //
          $id = $request->get('id');
          if($id=='#'){
              return ['text'=>'根节点', 'icon'=>'fa fa-home', children: true];
          }
          
          // "select id, title as text from cats where parent = $id"
          $nodes = App\Models\CatModel::WhereParent($id)->get();
         	
          return $nodes->transform(function($rs){
              // 数据库字段与jstree字段可能不一致
              $rs->text = $rs->name;
              $rs->children = $rs->num_childs ? true : false;
              return $rs;
          });
      }
  
  ```




### 常用交互及事件处理

* 示例中的事件处理, 是先前端Node的渲染, 完毕再异步请求/同步后端, 如果出错, 会重新刷新树

```js
$('#tree')
	.jstree({
		'core' : {
			'data' : {
				'url' : '?operation=get_node',
				'data' : function (node) {	// request data
					return { 'id' : node.id };
				}
			},
			'force_text' : true,
			'check_callback' : true,
			'themes' : {
				'responsive' : false
			}
		},
		'plugins' : ['state','dnd','contextmenu','wholerow']
	})
	.on('delete_node.jstree', function (e, data) {
		$.get('?operation=delete_node', { 'id' : data.node.id })
			.fail(function () {
				data.instance.refresh();
			});
	})
	.on('create_node.jstree', function (e, data) {
		$.get('?operation=create_node', { 'id' : data.node.parent, 'position' : data.position, 'text' : data.node.text })
			.done(function (d) {
				data.instance.set_id(data.node, d.id);
			})
			.fail(function () {
				data.instance.refresh();
			});
	})
	.on('rename_node.jstree', function (e, data) {
		$.get('?operation=rename_node', { 'id' : data.node.id, 'text' : data.text })
			.fail(function () {
				data.instance.refresh();
			});
	})
	.on('move_node.jstree', function (e, data) {
		$.get('?operation=move_node', { 'id' : data.node.id, 'parent' : data.parent, 'position' : data.position })
			.fail(function () {
				data.instance.refresh();
			});
	})
	.on('copy_node.jstree', function (e, data) {
		$.get('?operation=copy_node', { 'id' : data.original.id, 'parent' : data.parent, 'position' : data.position })
			.always(function () {
				data.instance.refresh();
			});
	})
	.on('changed.jstree', function (e, data) {
		if(data && data.selected && data.selected.length) {
			$.get('?operation=get_content&id=' + data.selected.join(':'), function (d) {
				$('#data .default').text(d.content).show();
			});
		}
		else {
			$('#data .content').hide();
			$('#data .default').text('Select a file from the tree.').show();
		}
	});
});
```



### 数据格式

* 对象型/递归型,全部数据就一个对象

  > 不要为节点设置 parent属性,会减慢速度

  ```js
  // 此为一个节点
  {
    id          : "string" // will be autogenerated if omitted
    text        : "string" // 显示的节点名称
    icon        : "string" // 图标,例如 "fa fa-file"
    state       : {
      opened    : boolean  // is the node open
      disabled  : boolean  // is the node disabled
      selected  : boolean  // is the node selected
    },
    children    : []  // 子节点数组, 可为true和false,进行ajax动态查询
    li_attr     : {}  // 在节点dom上添加 li-attr=""
    a_attr      : {}  // 在节点dom上添加 a_attr=""
  }
  $('#tree').jstree({
      core: data: {node}
  })
  ```

* 数组型,顺序表

  > 这个慢, 会根据id,parent自动生成树, 每个节点必须指定id,parent

  ```js
  // 节点示例
  {
      id          : "string" // required
      parent      : "string" // required, 
      text        : "string" // node text  
      icon        : "string" // string for custom
      state       : {
          opened    : boolean  // is the node open
          disabled  : boolean  // is the node disabled
          selected  : boolean  // is the node selected
      },
      li_attr     : {}  // attributes for the generated LI node
      a_attr      : {}  // attributes for the generated A node
  }
  
  $('#tree').jstree({
      core: {data: [{}, {}, {}]}
  });
  
  ```


### Ajax动态加载

* 自动Ajax请求

  > 展开节点时会自动请求Ajax, 定义好ajaxUrl和请求参数即可
  >
  > 服务器返回的数据, 设置节点的 children=true, 表示有子节点,展开时会再次请求

  ```js
  // 在服务器端, 返回结构 [ {node}, {node} ]
  // 返加节点数据的 children=true, 表示展开时刷新, 也可以指定递归对象
  // url, data 参数均可为闭包
  $('#tree').jstree({
      core:{
          data: {
              url: function(node){
                  return node.id=='#' ? 'get_root.php' : 'get_node.php';
              },
              data: function(node){	// 请求URL时附带的数据
                  return {id: node.id};
              }
              ,// 可跟 dataType, type 等, $.ajax参数
          }
      }
  });
  
  // HTTP POST: get_node.php
  data =  {
      url: 'get_node.php',
      data: function(node){ return {id: node.id; }},
      type: 'post'
  };
  
  // HTTP GET: get_node.php?id=nodeId
  data = {
      url: function(node){ return 'get_node.php?id='+node.id; }
  }
  
  
  ```

* 自定义数据及请求 (建议)

  > 根节点通常在前端直接写了, 不同情况下"根节点"的名称也不尽相同, 或许不需要. 此种情况使后端逻辑复杂化
  >
  > 因此下列这种方式更适合前后端分离

  ```js
  $('#jstree').jstree({
      core: {
          data: function(obj, callback){
              if(obj.id=='#'){
                  // 立即回调
                  return callback({id:'0', text:'根节点', children: true, icon:'fa fa-home'});
              }
              // 自定义请求, 异步, 服务器返回后再告之jstree进行渲染
              $.get(url, {id: obj.id}, null, 'json')
                  .done(function(json){
                  	cb(json);
              	})
                  .fail(function(){
                  	inst.refresh();
              })
          }
      }
  });
  ```


### 节点类型及图标

* 直接写在jsonData里,并不是太好处理, 前端不好个性化, 可能要把 css class写入数据库, 当需求变更时, 也需要频繁修改后端.

  ```php
  // some ajax request
  $data = array('text'=>'根节点', 'icon'=>'fa fa-home', 'children'=>true); 
  // $data = DB::table('sometable')->whereParent($id)->get();
  echo json_encode($data);
  ```

* 使用`types plugin`, 根据节点的`type`属性, 来定义相关的前端显示.

  例如我们做`CMS`系统时, 有栏目树, 栏目类型有 '单页', '目录', '分类', '文章列表', '纯链接', 等等, 只需在数据库里存取'type'类型, 在前端根据类型来自定义图标,或者切换主题风格.

  例如下列的一个文件目录树:

  ```php
  // $data = db::someQuery();
  // 注意返回的每个节点都有个`type`属性
  $data = [
  	'text'=>'根节点', 
  	'type'=>'root', 
      'children'=> [
  		['text'=>'目录', 'type'=>'dir', 'children'=>true], 
          ['text'=>'文件', 'type'=>'file'],
          ['text'=>'图片', 'type'=>'image']
      ];
  echo json_encode($data);
  ```

  ```js
  // 前端, 根据节点的 'type' 字段来显示个性化图标与样式
  $('#tree').jstree({
      core: { "..." : "..." },
      types: {
          default: {icon: 'fa fa-file'},
          root: {icon: 'fa fa-home'},
          file: {icon: 'fa fa-file-o', 'li-attr':'type-file'},
          dir: {icon: 'fa fa-folder-o'}
      },
      plugins: ['types']
  });
  
  // 根据 types li-attr / a-attr 设置节点样式
  // .jstree li.jstree-node[li-attr="type-file"] { color:#f22; }
  
  ```


### 右键菜单

* 快速使用, 注意代码里`check_callback`参数的作用, 否则默认的菜单动作不会执行

  ```js
  // core.check_callback 必须 为 true, 或者闭包, 内部根据返回值来判断是否执行菜单动作
  $('#tree').jstree({
      core : {
          "check_callback": true,
          // check_callback: function(chk, obj, par, pos, more) { return true; }
          "...": "..."
      }, 
      plugins: ['contextmenu'],
      contextmenu: {
          select_node: true, // defaults
          show_at_node: true,	// defaults
          items: function(o, cb){
              return {
                  create: {
                      icon: 'fa fa-plus',
                      label: 'create',
                      action: function(data){
                          var inst = $.jstree.reference(data.reference),
  						obj = inst.get_node(data.reference);
                          //
                      }
                  },
                  'ccp': {	// 子菜单
                      icon: false,
                      label: 'edit',
                      submenu: {
                          'cut':  { label: 'cut'},
                          'copy': { label: 'copy'},
                          'paste': { label: 'paste'}
                      }
                  }
              }
          }
      }
  });
  ```

* 默认的菜单参考 `jstree.js $.jstree.defaults.contextmenu = { ...  };` 部分

  ```js
  $.jstree.defaults.contextmenu = {
  	select_node : true,
  	show_at_node : true,
      items: function(o, cb){
          return {
              // ...
          }
      }
  }
  ```

* 汉化默认菜单

  ```js
  // 基于原始修改
  (function(){
      var menuItems = $.jstree.defaults.contextmenu.items();
      $.extend(menuItems, {
          'create': {label:'新建', icon:'fa fa-plus-circle'},
          'rename': {label: '重命名', icon: 'fa fa-edit'},
          'remove': {label: '删除', icon: 'fa fa-trash'},
          'cpp': {
              label:'编辑', 
              submenu: {
                  cut: {label:'剪切', icon: 'fa fa-cut'},
                  copy: {label:'复制', icon: 'fa fa-copy'},
                  paste: {label:'粘贴', icon: 'fa fa-paste'}
              }
          }
      }, true);
  
      $.jstree.defaults.contextmenu.items = function(o, cb){
          return menuItems;
      }
  
  })();
  
  // 复制 jstree.js $.jstree.defaults.contextmenu 部分
  // 建立 jstree.zh-ch.js, 修改, 并加入项目
  
  ```



### 获取实例, 调用API

* API 参考 https://www.jstree.com/api

```js
// 初始化
$('#tree').jstree({
    '...': '...'
});

// 获取实例
var inst = $('#tree').jstree();

// 调用api
inst.refresh();
// 或
$('#tree').jstree('refresh');


// 其它方法:
// $.fn.jstree
$('#tree1').jstree(); // creates an instance
$('#tree2').jstree({ plugins : [] }); // create an instance with some options
$('#tree1').jstree('open_node', '#branch_1'); // call a method on an existing instance, passing additional arguments
$('#tree2').jstree(); // get an existing instance (or create an instance)
$('#tree2').jstree(true); // get an existing instance (will not create new instance)
$('#branch_1').jstree().select_node('#branch_1'); // get an instance (using a nested element and call a method)

// 根据dom获取实例
$.jstree.reference('tree');
$.jstree.reference('#tree');
$.jstree.reference($('#tree'));
$.jstree.reference(document.getElementByID('tree'));
$.jstree.reference('branch');
$.jstree.reference('#branch');
$.jstree.reference($('#branch'));
$.jstree.reference(document.getElementByID('branch'));
```



### 原始数据

```js
// 事件中获取原始数据

```



### 主要事件

* 初始化, 就绪

  ```js
  // init.jstree: 可能收不到
  // loaded.jstree: 根节点(id:#)已加载,这个节点不会显示
  // ready.jstree: triggered after all nodes are finished loading
  
  var __jstree = null;
  
  $('#tree').jstree({
      "..." : "..."
  })
      .on('ready.jstree', function(e, data){
          __jstree = data.instance;
          console.log('ready');
      });
  ```

* 选中,焦点变化

  ```js
  .on('changed.jstree', function (e, data) {
      if(data && data.selected && data.selected.length) {
          
      }
  }
  ```
